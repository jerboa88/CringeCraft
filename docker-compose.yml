version: '3.8'
services:
  mcserver:
    build: .
    environment:
      EULA: true
      TYPE: PAPER
      VERSION: 1.19.4
      INIT_MEMORY: 2G
      MAX_MEMORY: 8G
      # Load server icon and plugin list from container config
      ICON: /container/logo.png
      MODS_FILE: /container/plugins.txt
      REMOVE_OLD_MODS: true
      COPY_CONFIG_DEST: /data
      ENV_VARIABLE_PREFIX: CFG_
      SYNC_SKIP_NEWER_IN_DESTINATION: false
      REPLACE_ENV_VARIABLES: true
      REPLACE_ENV_DURING_SYNC: true
      # The image will run a script to replace instances of these variables with the secret values Docker loaded
      CFG_BSTATS_SERVER_UUID_FILE: /run/secrets/bstats_server_uuid
      CFG_DISCORD_BOT_TOKEN_FILE: /run/secrets/discord_bot_token
      CFG_DISCORD_SERVER_ID_FILE: /run/secrets/discord_server_id
      CFG_DISCORD_PRIMARY_CHANNEL_ID_FILE: /run/secrets/discord_primary_channel_id
      CFG_DISCORD_STAFF_CHANNEL_ID_FILE: /run/secrets/discord_staff_channel_id
      CFG_DISCORD_CONSOLE_CHANNEL_ID_FILE: /run/secrets/discord_console_channel_id
      CFG_DISCORD_USER_ROLE_ID_FILE: /run/secrets/discord_user_role_id
      CFG_DISCORD_ADMIN_ROLE_ID_FILE: /run/secrets/discord_admin_role_id
      CFG_LUCKPERMS_DB_PASSWORD_FILE: /run/secrets/luckperms_db_password
      # This will let Docker set `RCON_PASSWORD` to the value loaded from the secrets file
      RCON_PASSWORD_FILE: /run/secrets/rcon_password
    networks:
      cringenet:
        ipv4_address: 10.0.0.10
    ports:
      # Required so we can connect to the server locally
      - 25565:25565
    restart: unless-stopped
    secrets:
      - bstats_server_uuid
      - discord_bot_token
      - discord_server_id
      - discord_primary_channel_id
      - discord_staff_channel_id
      - discord_console_channel_id
      - discord_user_role_id
      - discord_admin_role_id
      - luckperms_db_password
      - rcon_password
    stdin_open: true
    tty: true
    volumes:
      - mcserver-volume:/data:rw
      # Files in `config/server/` will be copied to the container's `/data` directory
      - ./config/server:/config:ro
      # Files in `config/container/` will be mounted so that the image can read them
      - ./config/container:/container:ro
  playit:
    image: playit-image
    environment:
      PLAYIT_SECRET_FILE: /run/secrets/playit_agent_secret
    networks:
      - cringenet
    ports:
      - 44217:44217
      - 11118:11118
    restart: unless-stopped
    secrets:
      - playit_agent_secret
    volumes:
      - playit-volume:/app
networks:
  cringenet:
    ipam:
      config:
        - subnet: 10.0.0.10/24
secrets:
  bstats_server_uuid:
    file: ./config/secrets/bstats_server_uuid.txt
  discord_bot_token:
    file: ./config/secrets/discord_bot_token.txt
  discord_server_id:
    file: ./config/secrets/discord_server_id.txt
  discord_primary_channel_id:
    file: ./config/secrets/discord_primary_channel_id.txt
  discord_staff_channel_id:
    file: ./config/secrets/discord_staff_channel_id.txt
  discord_console_channel_id:
    file: ./config/secrets/discord_console_channel_id.txt
  discord_user_role_id:
    file: ./config/secrets/discord_user_role_id.txt
  discord_admin_role_id:
    file: ./config/secrets/discord_admin_role_id.txt
  luckperms_db_password:
    file: ./config/secrets/luckperms_db_password.txt
  playit_agent_secret:
    file: ./config/secrets/playit_agent_secret.txt
  rcon_password:
    file: ./config/secrets/rcon_password.txt
volumes:
  mcserver-volume:
  playit-volume:
    external: false
